import os
from androguard.misc import AnalyzeAPK
import pandas as pd
from pathlib import Path


# <-- Global Variables -->
row = 0
  

def CSVFormat(path, filename, label):
    
    df = pd.read_csv("intents.csv")
    new_row = dict.fromkeys(df, 0)    
    new_row[df.columns[0]] = filename
    new_row[df.columns[df.shape[1]-1]] = label
    df = df.append(new_row, ignore_index = True)
    
    try:
        a, d, dx = AnalyzeAPK(r"" + path)
        intent_list = []

        for activity in a.get_activities():
            for action,intent_name in a.get_intent_filters('activity', activity).items():
                for intent in intent_name:
                    intent_list.append(intent)
  
        
        for service in a.get_services():
            for action,intent_name in a.get_intent_filters('service', service).items():
                for intent in intent_name:
                    intent_list.append(intent)          
            
        
        for receiver in a.get_receivers():
            for action,intent_name in a.get_intent_filters('receiver', receiver).items():
                for intent in intent_name:
                    intent_list.append(intent)
        
        for col in df.columns:
            for index in intent_list:
                if(col == index):
                    df.loc[row, col] = 1
               

    except Exception:
        print(Exception)

    print(df)
    df.to_csv('intents.csv', index = False)    

          

def ShiftToCSV():

    data = pd.read_csv('DefaultIntentList.txt',sep='\n',header=None)
    data = data.set_index(0).T
    data.to_csv('intents.csv', index = False)
    

        

def main():
    
    global row
    ShiftToCSV()

    parent_dir = r'F:\FYP CONTENTS\Data\APK Testing Datasets'

    try:
        for subdir, dirs, files in os.walk(parent_dir):
            for file in files:
                if file.endswith(".apk"):
                    label = Path(os.path.join(subdir, file)).parts[-2]
                    CSVFormat(os.path.join(subdir, file), file, label)
                    row += 1
                    continue
                else:
                    print('Skipping file..')
                    continue
                
    except Exception:
        print(Exception)



if __name__ == '__main__':
    main()
  



